/*
 * Copyright (c) 2014-2015 Thomas Kern
 *
 * Permission is hereby granted, free of charge, to any person obtaining a
 * copy of this software and associated documentation files (the "Software"),
 * to deal in the Software without restriction, including without limitation
 * the rights to use, copy, modify, merge, publish, distribute, sublicense,
 * and/or sell copies of the Software, and to permit persons to whom the
 * Software is furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
 * DEALINGS IN THE SOFTWARE.
 */

/**
 * Return a function to request the specified diagram
 * from a plant UML server and create the appropriate
 * image block.
 * @param diagram One of "plantuml", "ditaa", or "graphviz"
 * @returns {Function}
 */
function process_function(diagram) {

    return function (parent, reader, attrs) {
        var nil = Opal.nil,
            $hash2 = Opal.hash2,
            self = this;

        var title = "" + (attrs['$[]']("title"));
        var alt = "" + (attrs['$[]']("alt"));
        var caption = "" + (attrs['$[]']("caption"));
        var width = "" + (attrs['$[]']("width"));
        var height = "" + (attrs['$[]']("height"));
        var scale = "" + (attrs['$[]']("scale"));
        var align = "" + (attrs['$[]']("align"));
        var type = "" + (attrs['$[]']("type"));


        var filename = (attrs['$[]']("target"));
        if (filename == nil) {
            filename = attrs['$[]'](2);
        }

        var format = (attrs['$[]']("format"));
        if (format == nil) {
            format = attrs['$[]'](3);
        }

        // Request diagram from plant UML server
        var content = plantUml(diagram, format, plantUmlServerUrl, reader.$read());
        if (format !== nil && (("" + format) === "txt")) {
            return self.$create_literal_block(parent, content, attrs, $hash2(["subs"], {
                "subs": nil
            }));
        } else {
            var attributesHash = {
                "target": content,
                "title": title,
                "alt": alt,
                "caption": caption,
                "width": width,
                "height": height,
                "scale": scale,
                "align": align
            };

            var keys = Object.keys(attributesHash);

            keys.forEach(function (key) {
                if (attributesHash[key] == "")
                    delete attributesHash[key];
            });

            return self.$create_image_block(parent, $hash2(Object.keys(attributesHash), attributesHash));
        }
    };
}

/**
 * Create and register extension for UML diagrams
 */

/* Generated by Opal 0.6.3 */
(function ($opal) {
    var $a, self = $opal.top,
        nil = $opal.nil,
        $scope = $opal;

    self.$include((($a = $opal.Object._scope.Asciidoctor) == null ? $opal.cm('Asciidoctor') : $a));
    return (function ($base, $super) {
        function $UmlBlock() {
        }

        var self = $opal.klass($base, $super, 'UmlBlock', $UmlBlock);

        self.$use_dsl();
        self.$named("plantuml");
        self.$on_context(["literal", "open"]);
        self.$parse_content_as("literal");

        return (self._proto.$process = process_function("plantuml"), nil) && 'process';
    })(self, ($scope.Extensions)._scope.BlockProcessor);
})(Opal);

/* Generated by Opal 0.6.3 */
(function ($opal) {
    var $a, $b, TMP_1, self = $opal.top,
        $scope = $opal;

    return ($a = ($b = $scope.Extensions).$register, $a._p = (TMP_1 = function () {
        var self = TMP_1._s || this;

        return self.$block($scope.UmlBlock);
    }, TMP_1._s = self, TMP_1), $a).call($b);
})(Opal);

/**
 * Create and register extension for ditaa
 */

/* Generated by Opal 0.6.3 */
(function ($opal) {
    var $a, self = $opal.top,
        nil = $opal.nil,
        $scope = $opal;

    self.$include((($a = $opal.Object._scope.Asciidoctor) == null ? $opal.cm('Asciidoctor') : $a));
    return (function ($base, $super) {
        function $DitaaBlock() {
        }

        var self = $opal.klass($base, $super, 'DitaaBlock', $DitaaBlock);

        self.$use_dsl();
        self.$named("ditaa");
        self.$on_context(["literal", "open"]);
        self.$parse_content_as("literal");

        return (self._proto.$process = process_function("ditaa"), nil) && 'process';
    })(self, ($scope.Extensions)._scope.BlockProcessor);
})(Opal);

/* Generated by Opal 0.6.3 */
(function ($opal) {
    var $a, $b, TMP_1, self = $opal.top,
        $scope = $opal;

    return ($a = ($b = $scope.Extensions).$register, $a._p = (TMP_1 = function () {
        var self = TMP_1._s || this;

        return self.$block($scope.DitaaBlock);
    }, TMP_1._s = self, TMP_1), $a).call($b);
})(Opal);


/**
 * Create and register extension for Graphviz
 */

/* Generated by Opal 0.6.3 */
(function ($opal) {
    var $a, self = $opal.top,
        nil = $opal.nil,
        $scope = $opal;

    self.$include((($a = $opal.Object._scope.Asciidoctor) == null ? $opal.cm('Asciidoctor') : $a));
    return (function ($base, $super) {
        function $DotBlock() {
        }

        var self = $opal.klass($base, $super, 'DotBlock', $DotBlock);

        self.$use_dsl();
        self.$named("graphviz");
        self.$on_context(["literal", "open"]);
        self.$parse_content_as("literal");

        return (self._proto.$process = process_function("graphviz"), nil) && 'process';
    })(self, ($scope.Extensions)._scope.BlockProcessor);
})(Opal);

/* Generated by Opal 0.6.3 */
(function ($opal) {
    var $a, $b, TMP_1, self = $opal.top,
        $scope = $opal;

    return ($a = ($b = $scope.Extensions).$register, $a._p = (TMP_1 = function () {
        var self = TMP_1._s || this;

        return self.$block($scope.DotBlock);
    }, TMP_1._s = self, TMP_1), $a).call($b);
})(Opal);